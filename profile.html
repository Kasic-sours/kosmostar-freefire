<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Профиль игрока — KOSMOSTAR</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 20px auto; }
    img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 10px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    #status { text-align: center; }
  </style>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <!-- Firebase JS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <h2>Профиль игрока</h2>
  <img id="avatarPreview" src="https://via.placeholder.com/120" alt="Аватар" />
  <input type="file" id="avatarInput" accept="image/*" />
  <input type="text" id="displayName" placeholder="Имя" />
  <input type="text" id="ffId" placeholder="Free Fire ID" />
  <button id="saveBtn">Сохранить</button>
  <button id="logoutBtn">Выйти</button>
  <p id="status"></p>

<script>
  // === Firebase Auth настройки (замени на свои) ===
  const firebaseConfig = {
    apiKey: "AIzaSyCEuQ0e68vtnlncSF0szRw3sx8H_c5JtXA",
    authDomain: "kosmostar-auth.firebaseapp.com",
    projectId: "kosmostar-auth",
    storageBucket: "kosmostar-auth.appspot.com",
    messagingSenderId: "364152131416",
    appId: "1:364152131416:web:343964c346664e960cdf2d"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // === Supabase настройки (замени на свои) ===
  const SUPABASE_URL = 'https://hcaabrjkqykhnerikpdy.supabase.co'; // Вставь свой URL
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjYWFicmprcXlraG5lcmlrcGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTM5OTIsImV4cCI6MjA2OTg4OTk5Mn0.t6nzur8nNnaezAv2H63RBGdAkwfWQR31fGXC1OYHlpQ'; // Вставь свой публичный анонимный ключ
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const avatarInput = document.getElementById('avatarInput');
  const avatarPreview = document.getElementById('avatarPreview');
  const displayName = document.getElementById('displayName');
  const ffId = document.getElementById('ffId');
  const status = document.getElementById('status');

  auth.onAuthStateChanged(async user => {
    if (!user) {
      // Если пользователь не вошел — отправляем на страницу входа
      window.location.href = 'index.html';
      return;
    }

    const userId = user.uid;

    // Загружаем профиль из Supabase
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 — запись не найдена, это нормально
      status.style.color = 'red';
      status.textContent = 'Ошибка загрузки профиля: ' + error.message;
      return;
    }

    if (data) {
      displayName.value = data.display_name || '';
      ffId.value = data.freefire_id || '';
      if (data.avatar_url) {
        avatarPreview.src = data.avatar_url;
      }
    }

    document.getElementById('saveBtn').onclick = async () => {
      status.textContent = '';
      let avatarUrl = data?.avatar_url || null;

      if (avatarInput.files.length > 0) {
        const file = avatarInput.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${userId}.${fileExt}`;
        const filePath = `avatars/${fileName}`;

        // Загружаем файл в Supabase Storage
        const { error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(filePath, file, { upsert: true });

        if (uploadError) {
          status.style.color = 'red';
          status.textContent = 'Ошибка загрузки аватара: ' + uploadError.message;
          return;
        }

        // Получаем публичный URL загруженного аватара
        const { data: publicUrlData } = supabase.storage
          .from('avatars')
          .getPublicUrl(filePath);

        avatarUrl = publicUrlData.publicUrl;
        avatarPreview.src = avatarUrl;
      }

      // Обновляем или вставляем данные профиля
      const { error: upsertError } = await supabase
        .from('profiles')
        .upsert({
          id: userId,
          display_name: displayName.value,
          freefire_id: ffId.value,
          avatar_url: avatarUrl,
        });

      if (upsertError) {
        status.style.color = 'red';
        status.textContent = 'Ошибка сохранения профиля: ' + upsertError.message;
        return;
      }

      status.style.color = 'green';
      status.textContent = 'Профиль успешно обновлён!';
    };

    document.getElementById('logoutBtn').onclick = () => {
      auth.signOut().then(() => window.location.href = 'index.html');
    };
  });
</script>
</body>
</html>
